# Redis持久化
>Redis提供如下的持久化选项：
- RDB 每隔指定的时间间隔就将当前时间点的数据集快照持久化。
- AOF 在服务端每次接收到写入操作请求时都持久化logs;在服务启动时，会对logs进行回放，以‘重构恢复’原始数据集。所有操作命令都会被通过Redis内部协议写入logs,当logs太大时，redis可以重写它。
- 如果只需要数据在redis运行期间存在，就可以完全关闭持久化。
- 将RDB和AOF结合。在服务启动时，AOF会被用于重建数据集。
- RDB和AOF各有优缺点，需要自行权衡。

## RDB 优势
- RDB是存储Redis当前时间点数据集的压缩文件。RDB文件对备份来说是很完美的，可以灵活使用备份策略生成各种不同时间点(采用不同的备份频率生成，如每隔24小时/每隔30天生成一个文件)的数据文件作为灾备。
- RDB 可以很容易地用于灾备数据回复，作为压缩文件可以进行远距离传输。
- RDB 可以最大限度地提高Redis的性能，需要持久化时父进程只需要fork一个子进程，由此子进程来完成持久化任务，父进程不需要涉及I/O或者类似操作。

## RDB 劣势
- RDB 不能在Redis异常时(如断电)尽可能地降低数据丢失的可能。在发生异常时，redis可能会丢失最近几分钟的数据。
- RDB需要fork子进程完成持久化任务，而在数据量比较大的情况下，fork子任务需要消耗CPU而引起服务在一段时间内无法响应客户端请求。而AOF虽然也需要fork，但是你可以自动调节logs的重写频率。

## AOF 优势
- AOF模式使Redis更耐用。我们可以采用不同的fsync策略：
  - 完全不执行fsync
  - 每秒钟执行一次fsync 默认策略
  - 每次查询时执行fsync

- AOF log 只能append，所以它不会发生随机写问题。即使断电时AOF log最后只写了一半命令，redis-check-aof 工具可以将其修复。
- 当AOF log太大时，Redis会在后台自动重写log.即使在Redis持续向旧log中写入，重写是完全安全的。
- AOF log存储了所有操作命令且易于理解和解析。即使你错误地使用了FLUSHALL 命令，如果在执行命令后没有执行log 重写，我们可以Stop Redis,删除log中的最新命令，然后重启Redis就可以恢复数据。
  
## AOF 劣势
- 对同一数据集来说，AOF文件要比RDB文件大。
- 依赖于定时刷盘策略的AOF要比RDB慢。而且即使在大量写入负载的情况下，RDB可以提供最大延迟的保证。
- 由于使用增量模式，AOF可能会出现一些隐秘的bug；而RDB却不会。

## 应该使用哪一个？
- 在实际应用中，如果想要数据非常安全，就需要同时使用RDB和AOF.
- 如果你可以接受丢失几分钟的数据，那么久使用RDB.
- 对于只使用AOF的做法，不鼓励，因为RDB是一种非常有效的数据备份方式且可以让启动服务更快速。AOF引擎有可能存在隐秘的bug.
- 基于以上，后续版本可能会推出能够兼备RDB和AOF长处的持久化方式。

## 快照方式
>默认情况下Redis将数据存在磁盘中一个名称为dump.rdb的文件中。快照生成策略配置的方式：每隔N秒钟如果有至少M个修改时保存一次，或者可以手动调用SAVE或者BGSAVE命令。
### 工作方式
>当Redis需要生成一个快照保存到磁盘时，以下是执行的过程：
- fork 一个子进程
- 子进程将数据集写入临时RDB文件
- 子进程写入数据完毕之后，新的RDB文件替换旧的RDB文件

## AOF
